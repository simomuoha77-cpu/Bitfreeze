<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Bitfreeze</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: Arial, sans-serif; background: #0f1720; color: #fff; }
    .wrap { padding: 20px; max-width: 900px; margin: auto; background: rgba(0,0,0,0.4); border-radius: 8px; }
    .card { background: rgba(255,255,255,0.04); padding: 15px; margin: 10px 0; border-radius: 8px; }
    .small { font-size: 0.9em; color: #ddd; }
    .fridge { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .fridge img { width: 100px; height: auto; margin-right: 10px; }
    input, button { padding:8px; margin:6px 0; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); color: #fff; width:100%; box-sizing:border-box; }
    button { cursor:pointer; }
    .form-row { display:flex; gap:8px; }
    .form-row > * { flex:1; }
    .btn { padding:8px 12px; border-radius:6px; background:#ffb000; color:#000; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Your Dashboard</h2>
    <div id="usercard" class="card">Loading...</div>

    <h3>Deposit ðŸ’°</h3>
    <div class="card">
      <div class="form-row">
        <input id="depositPhone" placeholder="Your phone (07...)" />
      </div>
      <input id="depositAmount" placeholder="Amount KES e.g. 500" />
      <button id="doDeposit" class="btn">Deposit ðŸ’°</button>
      <div id="depositMsg" class="small"></div>
    </div>

    <h3>Withdraw ðŸ’¸</h3>
    <div class="card">
      <input id="withdrawAmount" placeholder="Amount KES e.g. 500" />
      <input id="withdrawPhone" placeholder="Phone used to deposit (07...)" />
      <button id="doWithdraw" class="btn">Withdraw ðŸ’¸</button>
      <div id="withdrawMsg" class="small"></div>
    </div>

    <h3>Available Fridges ðŸ§Š</h3>
    <div id="fridgelist" class="card"></div>

    <p class="small">Logout: <a href="#" id="logout">click</a></p>
  </div>

<script>
const token = localStorage.getItem('bf_token');
if (!token) location.href = 'login.html';

async function api(path, method='GET', body) {
  const headers = { 'Authorization': 'Bearer ' + token };
  if (body) headers['content-type']='application/json';
  const r = await fetch('/api/'+path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  return r.json();
}

// Load user info & fridges
async function load() {
  const me = await api('me');
  if (me.error) { alert('Session expired'); localStorage.removeItem('bf_token'); location.href='login.html'; return; }
  const u = me.user;

  document.getElementById('usercard').innerHTML = `<b>${u.email}</b>
    <div class="small">Balance: ðŸ’° KES ${u.balance || 0}</div>
    <div class="small">Fridges owned: ${(u.fridges||[]).length}</div>`;

  const list = await api('fridges');
  const container = document.getElementById('fridgelist');
  container.innerHTML = '';
  list.fridges.forEach(f=>{
    const el = document.createElement('div');
    el.className = 'fridge';
    el.innerHTML = `<div style="display:flex;align-items:center">
        <img src="images/fridge2ft.jpg" alt="${f.name}">
        <div>
          <b>${f.name}</b>
          <div class="small">Price: ðŸ’° KES ${f.price} â€” Earn: ðŸ’° ${f.dailyEarn}/day</div>
        </div>
      </div>
      <div>
        <button class="btn buy" data-id="${f.id}">Buy ðŸ’° ${f.price}</button>
      </div>`;
    container.appendChild(el);
  });

  document.querySelectorAll('.buy').forEach(b=>{
    b.onclick = async (e) => {
      const id = e.target.dataset.id;
      const res = await api('buy','POST',{fridgeId: id});
      if (res.error) alert(res.error); else { alert(res.message); load(); }
    };
  });
}

// Deposit
document.getElementById('doDeposit').onclick = async () => {
  const amount = Number(document.getElementById('depositAmount').value || 0);
  const phone = (document.getElementById('depositPhone').value || '').trim();
  const msg = document.getElementById('depositMsg');
  msg.innerText = '';
  if (!amount || !phone) { msg.innerText = 'Enter amount and phone ðŸ’°'; return; }

  const r = await api('deposit','POST',{ amount, phone });
  if (r.error) msg.innerText = r.error; else { msg.innerText = r.message + ' ðŸ’°'; load(); }
};

// Withdraw
document.getElementById('doWithdraw').onclick = async () => {
  const amount = Number(document.getElementById('withdrawAmount').value || 0);
  const phone = (document.getElementById('withdrawPhone').value || '').trim();
  const msg = document.getElementById('withdrawMsg');
  msg.innerText = '';
  if (!amount || !phone) { msg.innerText = 'Enter amount and phone ðŸ’¸'; return; }

  const r = await api('withdraw','POST',{ amount, phone });
  if (r.error) msg.innerText = r.error; else { msg.innerText = r.message + ' ðŸ’¸'; load(); }
};

// Logout
document.getElementById('logout').onclick = () => { localStorage.removeItem('bf_token'); location.href='login.html'; };

// Auto refresh every 30s for live balance (including daily earnings)
setInterval(load, 30000);
load();
</script>
</body>
</html>
