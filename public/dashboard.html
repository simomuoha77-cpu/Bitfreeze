<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Bitfreeze</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: Arial, sans-serif; background: #0f1720; color: #fff; }
    .wrap { padding: 20px; max-width: 900px; margin: auto; background: rgba(0,0,0,0.4); border-radius: 8px; }
    .card { background: rgba(255,255,255,0.04); padding: 15px; margin: 10px 0; border-radius: 8px; }
    .small { font-size: 0.9em; color: #ddd; }
    .fridge { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .fridge img { width: 100px; height: auto; margin-right: 10px; }
    input, button { padding:8px; margin:6px 0; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); color: #fff; width:100%; box-sizing:border-box; }
    .form-row { display:flex; gap:8px; }
    .form-row > * { flex:1; }
    .btn { padding:8px 12px; border-radius:6px; background:#ffb000; color:#000; border:none; cursor:pointer; }
    .referral { background: rgba(255,255,255,0.06); padding:10px; border-radius:6px; margin:10px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Your Dashboard</h2>
    <div id="usercard" class="card">Loading...</div>

    <div class="referral card">
      <strong>Your Referral Link:</strong>
      <div id="referralLink">Loading...</div>
      <p class="small">Share this link. When a friend registers with it and deposits, you'll get rewards.</p>
    </div>

    <h3>Deposit ðŸ’°</h3>
    <div class="card">
      <div class="form-row">
        <input id="depositPhone" placeholder="Your phone (07...)" />
      </div>
      <input id="depositAmount" placeholder="Amount KES e.g. 500" />
      <button id="doDeposit" class="btn">Deposit ðŸ’° (STK / Sim)</button>
      <p class="small" id="depositNote">A payment prompt will be sent to your phone (if Daraja enabled). Otherwise local simulation is used.</p>
      <div id="depositMsg" class="small"></div>
    </div>

    <h3>Withdraw ðŸ’¸</h3>
    <div class="card">
      <input id="withdrawAmount" placeholder="Amount KES e.g. 500" />
      <input id="withdrawPhone" placeholder="Phone used to deposit (07...)" />
      <button id="doWithdraw" class="btn">Withdraw ðŸ’¸ (request)</button>
      <p class="small">Minimum withdrawal KES 200. Withdrawals are processed when admin approves.</p>
      <div id="withdrawMsg" class="small"></div>
    </div>

    <h3>Available Fridges ðŸ§Š</h3>
    <div id="fridgelist" class="card">Loading fridges...</div>

    <p class="small">Logout: <a href="#" id="logout">click</a></p>
  </div>

<script>
const token = localStorage.getItem('bf_token');
if (!token) location.href = 'login.html';

async function api(path, method='GET', body) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch('/api/' + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  return res.json();
}

async function load() {
  const me = await api('me');
  if (me.error) { alert('Session expired'); localStorage.removeItem('bf_token'); location.href='login.html'; return; }
  const u = me.user;
  document.getElementById('usercard').innerHTML = `<b>${u.email}</b>
    <div class="small">Phone: ${u.phone || 'â€”'}</div>
    <div class="small">Balance: ðŸ’° KES ${u.balance || 0}</div>
    <div class="small">Fridges owned: ${(u.fridges||[]).length}</div>`;

  // referral link (use email as id)
  const refEl = document.getElementById('referralLink');
  const refUrl = `${window.location.origin}/register.html?ref=${encodeURIComponent(u.email)}`;
  refEl.innerHTML = `<input readonly value="${refUrl}" style="width:100%"/>`;

  const data = await api('fridges');
  const list = document.getElementById('fridgelist');
  list.innerHTML = '';
  data.fridges.forEach(f => {
    const div = document.createElement('div');
    div.className = 'fridge';
    div.innerHTML = `<div style="display:flex;align-items:center">
        <img src="${f.img}" onerror="this.style.display='none'">
        <div><b>${f.name}</b><div class="small">Price: KES ${f.price} â€” Earn: KES ${f.dailyEarn}/day</div></div>
      </div>
      <div><button class="btn buy" data-id="${f.id}">Buy ðŸ’° ${f.price}</button></div>`;
    list.appendChild(div);
  });

  document.querySelectorAll('.buy').forEach(b => b.onclick = async (e) => {
    const res = await api('buy', 'POST', { fridgeId: e.target.dataset.id });
    if (res.error) alert(res.error); else { alert(res.message); load(); }
  });
}

document.getElementById('doDeposit').onclick = async () => {
  const phone = (document.getElementById('depositPhone').value || '').trim();
  const amount = Number(document.getElementById('depositAmount').value || 0);
  const msg = document.getElementById('depositMsg'); msg.innerText = 'Processing...';
  if (!phone || !amount) { msg.innerText = 'Phone and amount required'; return; }
  // For simulation you can prompt for pin (optional)
  let mpesaPin = null;
  if (!confirm('Using simulation? Click OK to use simulated M-PESA (requires PIN). Cancel to proceed without PIN.')) {
    mpesaPin = '';
  } else {
    mpesaPin = prompt('Enter simulated M-PESA PIN (for testing):','1234');
  }
  const r = await api('deposit', 'POST', { phone, amount, mpesaPin });
  if (r.error) msg.innerText = r.error;
  else { msg.innerText = r.message; load(); }
};

document.getElementById('doWithdraw').onclick = async () => {
  const phone = (document.getElementById('withdrawPhone').value || '').trim();
  const amount = Number(document.getElementById('withdrawAmount').value || 0);
  const msg = document.getElementById('withdrawMsg'); msg.innerText = 'Processing...';
  if (!phone || !amount) { msg.innerText = 'Phone and amount required'; return; }
  const r = await api('withdraw','POST',{ phone, amount });
  if (r.error) msg.innerText = r.error; else { msg.innerText = r.message; }
};

document.getElementById('logout').onclick = () => { localStorage.removeItem('bf_token'); location.href='login.html'; };

load();
</script>
</body>
</html>
