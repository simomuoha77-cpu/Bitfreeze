<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard - Bitfreeze</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <style>
    body { font-family: Arial, sans-serif; background: #0f1720; color: #fff; }
    .wrap { padding: 20px; max-width: 900px; margin: auto; background: rgba(0,0,0,0.4); border-radius: 8px; }
    .card { background: rgba(255,255,255,0.04); padding: 15px; margin: 10px 0; border-radius: 8px; }
    .small { font-size: 0.9em; color: #ddd; }
    .fridge { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .fridge img { width: 100px; height: auto; margin-right: 10px; }
    input, button { padding:8px; margin:6px 0; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); color: #fff; width:100%; box-sizing:border-box; }
    button { cursor:pointer; }
    .form-row { display:flex; gap:8px; }
    .form-row > * { flex:1; }
    .btn { padding:8px 12px; border-radius:6px; background:#ffb000; color:#000; border:none; cursor:pointer; }
    .copy { margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Your Dashboard</h2>
    <div id="usercard" class="card">Loading...</div>

    <div id="referralCard" class="card small"></div>

    <h3>Deposit ðŸ’°</h3>
    <div class="card">
      <div class="form-row">
        <input id="depositPhone" placeholder="Your phone (07...)" />
      </div>
      <input id="depositAmount" placeholder="Amount KES e.g. 500" />
      <button id="doDeposit" class="btn">Deposit ðŸ’° (Simulated STK)</button>
      <p class="small">A payment prompt will be sent to your phone â€” enter your M-PESA PIN on your phone to confirm. Funds go to the site account (0707389787) and will be credited to your balance once confirmed.</p>
      <div id="depositMsg" class="small"></div>
    </div>

    <h3>Withdraw ðŸ’¸</h3>
    <div class="card">
      <input id="withdrawAmount" placeholder="Amount KES e.g. 500" />
      <input id="withdrawPhone" placeholder="Phone used to deposit (07...)" />
      <button id="doWithdraw" class="btn">Withdraw ðŸ’¸</button>
      <p class="small">Minimum withdrawal: KES 200. Only the phone used to deposit can withdraw.</p>
      <div id="withdrawMsg" class="small"></div>
    </div>

    <h3>Available Fridges ðŸ§Š</h3>
    <div id="fridgelist" class="card"></div>

    <p class="small">Logout: <a href="#" id="logout">click</a></p>
  </div>

<script>
const token = localStorage.getItem('bf_token');
if (!token) location.href = 'login.html';

async function api(path, method='GET', body) {
  const headers = { 'Authorization': 'Bearer ' + token };
  if (body) headers['content-type']='application/json';
  const r = await fetch('/api/'+path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  return r.json();
}

async function load() {
  const me = await api('me');
  if (me.error) { alert('Session expired'); localStorage.removeItem('bf_token'); location.href='login.html'; return; }
  const u = me.user;
  document.getElementById('usercard').innerHTML = `<b>${u.email}</b>
    <div class="small">Phone: ${u.phone || 'â€”'}</div>
    <div class="small">Balance: ðŸ’° KES ${u.balance || 0}</div>
    <div class="small">Fridges owned: ${(u.fridges||[]).length}</div>`;

  // referral card
  const referralCard = document.getElementById('referralCard');
  const referralLink = u.referralLink || `${location.origin}/register.html?ref=${u.referralCode}`;
  referralCard.innerHTML = `
    <div><b>Your referral link</b></div>
    <div style="word-break:break-all; margin:6px 0">${referralLink}</div>
    <button id="copyRef" class="btn copy">Copy referral link</button>
    <div class="small">Referral earnings: KES ${u.referralEarned || 0} â€” Earn according to deposit tiers (min KES 500).</div>
  `;
  document.getElementById('copyRef').onclick = () => {
    navigator.clipboard?.writeText(referralLink).then(()=> alert('Link copied to clipboard'));
  };

  // fridges
  const list = await api('fridges');
  const container = document.getElementById('fridgelist');
  container.innerHTML = '';
  list.fridges.forEach(f=>{
    const el = document.createElement('div');
    el.className = 'fridge';
    el.innerHTML = `<div style="display:flex;align-items:center">
        <img src="images/fridge2ft.jpg" alt="${f.name}">
        <div>
          <b>${f.name}</b>
          <div class="small">Price: ðŸ’° KES ${f.price} â€” Earn: ðŸ’° ${f.dailyEarn}/day</div>
        </div>
      </div>
      <div>
        <button class="btn buy" data-id="${f.id}">Buy ðŸ’° ${f.price}</button>
      </div>`;
    container.appendChild(el);
  });

  document.querySelectorAll('.buy').forEach(b=>{
    b.onclick = async (e) => {
      const id = e.target.dataset.id;
      const res = await api('buy','POST',{fridgeId: id});
      if (res.error) alert(res.error); else { alert(res.message); load(); }
    };
  });
}

document.getElementById('doDeposit').onclick = async () => {
  const amount = Number(document.getElementById('depositAmount').value || 0);
  const phone = (document.getElementById('depositPhone').value || '').trim();
  const msg = document.getElementById('depositMsg');
  msg.innerText = '';
  if (!amount || !phone) { msg.innerText = 'Enter amount and phone ðŸ’°'; return; }

  // For demo: ask user for PIN prompt (simulated). In production you do STK push and no PIN entered in site.
  const mpesaPin = prompt('Enter your M-PESA PIN (simulation):');
  if (!mpesaPin) { msg.innerText = 'M-PESA PIN required'; return; }

  const r = await api('deposit','POST',{ amount, phone, mpesaPin });
  if (r.error) msg.innerText = r.error; else { msg.innerText = r.message + ' ðŸ’°'; load(); }
};

document.getElementById('doWithdraw').onclick = async () => {
  const amount = Number(document.getElementById('withdrawAmount').value || 0);
  const phone = (document.getElementById('withdrawPhone').value || '').trim();
  const msg = document.getElementById('withdrawMsg');
  msg.innerText = '';
  if (!amount || !phone) { msg.innerText = 'Enter amount and phone ðŸ’¸'; return; }
  const r = await api('withdraw','POST',{ amount, phone });
  if (r.error) msg.innerText = r.error; else { msg.innerText = r.message + ' ðŸ’¸'; load(); }
};

document.getElementById('logout').onclick = () => { localStorage.removeItem('bf_token'); location.href='login.html'; };

load();
</script>
</body>
</html>
